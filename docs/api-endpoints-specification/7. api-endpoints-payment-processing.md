## 7. Payment Processing

### 7.1 Create Payment

**Description**: Initiates a payment for one or more bookings linked by `mainBookingId`. Returns a payment URL for the user to complete the transaction.

**HTTP Method**: POST  
**Endpoint**: `/api/payments`  
**Authorization**: Bearer Token (User)

**Request Body**:

```json
{
  "mainBookingId": "1",
  "amount": 740000.0,
  "paymentMethod": "VNPay"
}
```

**Response**:

- **201 Created**:

```json
{
  "paymentId": "1",
  "mainBookingId": "1",
  "amount": 740000.0,
  "status": "Pending",
  "paymentUrl": "https://sandbox.vnpay.vn/pay/123",
  "message": "Payment initiated successfully"
}
```

- **400 Bad Request**:

```json
{
  "error": "Invalid input",
  "details": [
    {
      "field": "amount",
      "message": "Amount must match booking total"
    }
  ]
}
```

- **401 Unauthorized**:

```json
{
  "error": "Unauthorized",
  "message": "Invalid or missing token"
}
```

- **403 Forbidden**:

```json
{
  "error": "Forbidden",
  "message": "Only the booking user can initiate payment"
}
```

- **404 Not Found**:

```json
{
  "error": "Resource not found",
  "message": "Booking not found"
}
```

**Note**:

- Creates a `Payment` record linked to `Booking.MainBookingId`.
- Validates `amount` against the total of all bookings with the same `mainBookingId`.
- `mainBookingId` is a string representing the `BookingId` (integer).
- `paymentUrl` is generated by the VNPay payment gateway (e.g., sandbox URL).
- Currently supports `VNPay` as the only `paymentMethod`.

### 7.2 Get Payment Status

**Description**: Retrieves the status of a payment.

**HTTP Method**: GET  
**Endpoint**: `/api/payments/{paymentId}`  
**Authorization**: Bearer Token (User or Owner)

**Path Parameters**:

- `paymentId` (required, integer): The ID of the payment.

**Request Example**:

```http
GET /api/payments/1
Authorization: Bearer {token}
```

**Response**:

- **200 OK**:

  ```json
  {
    "paymentId": 1,
    "bookingId": 1,
    "amount": 500000,
    "status": "Completed",
    "createdAt": "2025-06-01T10:00:00Z"
  }
  ```

- **401 Unauthorized**:

  ```json
  {
    "error": "Unauthorized",
    "message": "Invalid or missing token"
  }
  ```

- **403 Forbidden**:

  ```json
  {
    "error": "Forbidden",
    "message": "Only the booking user or field owner can view payment"
  }
  ```

- **404 Not Found**:

  ```json
  {
    "error": "Resource not found",
    "message": "Payment not found"
  }
  ```

**Note**:

- `status` reflects `Payment.Status` (Pending|Completed|Failed).

### 7.3 Get Payment History

**Description**: Retrieves payment history of the authenticated user or owner.

**HTTP Method**: GET  
**Endpoint**: `/api/payments`  
**Authorization**: Bearer Token (User or Owner)

**Query Parameters**:

- `page` (optional, integer, default: 1)
- `pageSize` (optional, integer, default: 10)
- `status` (optional, string: Pending|Completed|Failed)
- `startDate` (optional, date: YYYY-MM-DD)
- `endDate` (optional, date: YYYY-MM-DD)

**Request Example**:

```http
GET /api/payments?page=1&pageSize=10&status=Completed
Authorization: Bearer {token}
```

**Response**:

- **200 OK**:

  ```json
  {
    "data": [
      {
        "paymentId": 1,
        "bookingId": 1,
        "amount": 500000,
        "status": "Completed",
        "createdAt": "2025-06-01T10:00:00Z"
      }
    ],
    "total": 1,
    "page": 1,
    "pageSize": 10
  }
  ```

- **400 Bad Request**:

  ```json
  {
    "error": "Invalid input",
    "details": [
      {
        "field": "startDate",
        "message": "Invalid date format"
      }
    ]
  }
  ```

- **401 Unauthorized**:

  ```json
  {
    "error": "Unauthorized",
    "message": "Invalid or missing token"
  }
  ```

**Note**:

- For `User`, returns payments linked to their bookings.
- For `Owner`, returns payments linked to bookings on their fields.

### 7.4 Payment Webhook

**Description**: Handles payment updates from the payment gateway.

**HTTP Method**: POST  
**Endpoint**: `/api/payments/webhook`  
**Authorization**: None (secured by webhook signature)

**Request Body**:

```json
{
  "paymentId": 1,
  "status": "Success",
  "transactionId": "txn_123",
  "amount": 500000,
  "timestamp": "2025-06-01T10:00:00Z"
}
```

**Query Parameters**:

- `vnp_SecureHash` (required, string): Signature to verify the webhook.

**Response**:

- **200 OK**:

  ```json
  {
    "message": "Webhook processed successfully"
  }
  ```

- **400 Bad Request**:

  ```json
  {
    "error": "Invalid input",
    "details": [
      {
        "field": "paymentId",
        "message": "Payment ID is required"
      }
    ]
  }
  ```

- **401 Unauthorized**:

  ```json
  {
    "error": "Unauthorized",
    "message": "Invalid webhook signature"
  }
  ```

**Note**:

- Updates `Payment.Status` and `Booking.PaymentStatus`.
- Secured by `vnp_SecureHash` verified by the VNPay payment gateway.
- `status` is either `"Success"` or `"Failed"`.

### 7.5 Request Refund

**Description**: Requests a refund for a booking.

**HTTP Method**: POST  
**Endpoint**: `/api/payments/{paymentId}/refund`  
**Authorization**: Bearer Token (User)

**Path Parameters**:

- `paymentId` (required, integer): The ID of the payment.

**Request Body**:

```json
{
  "amount": 500000,
  "reason": "Booking cancelled"
}
```

**Response**:

- **201 Created**:

  ```json
  {
    "refundId": 1,
    "paymentId": 1,
    "amount": 500000,
    "status": "Pending",
    "message": "Refund requested successfully"
  }
  ```

- **400 Bad Request**:

  ```json
  {
    "error": "Invalid input",
    "details": [
      {
        "field": "amount",
        "message": "Refund amount exceeds payment amount"
      }
    ]
  }
  ```

- **401 Unauthorized**:

  ```json
  {
    "error": "Unauthorized",
    "message": "Invalid or missing token"
  }
  ```

- **403 Forbidden**:

  ```json
  {
    "error": "Forbidden",
    "message": "Only the booking user can request a refund"
  }
  ```

- **404 Not Found**:

  ```json
  {
    "error": "Resource not found",
    "message": "Payment not found"
  }
  ```

**Note**:

- Creates a `RefundRequest` record.
- Validates `Payment.Status` is Completed and refund eligibility.
- `amount` must not exceed the original `Payment.Amount`.

### 7.6 Process Refund

**Description**: Processes a refund request (Owner only).

**HTTP Method**: POST  
**Endpoint**: `/api/payments/refunds/{refundId}/process`  
**Authorization**: Bearer Token (Owner)

**Path Parameters**:

- `refundId` (required, integer): The ID of the refund request.

**Request Body**:

```json
{
  "status": "Approved",
  "note": "Refund approved due to cancellation"
}
```

**Response**:

- **200 OK**:

  ```json
  {
    "refundId": 1,
    "status": "Approved",
    "message": "Refund processed successfully"
  }
  ```

- **400 Bad Request**:

  ```json
  {
    "error": "Invalid input",
    "details": [
      {
        "field": "status",
        "message": "Invalid status"
      }
    ]
  }
  ```

- **401 Unauthorized**:

  ```json
  {
    "error": "Unauthorized",
    "message": "Invalid or missing token"
  }
  ```

- **403 Forbidden**:

  ```json
  {
    "error": "Forbidden",
    "message": "Only the field owner can process refunds"
  }
  ```

- **404 Not Found**:

  ```json
  {
    "error": "Resource not found",
    "message": "Refund request not found"
  }
  ```

**Note**:

- Updates `RefundRequest.Status` (Approved|Rejected).
- If approved, updates `Payment.Status` and `Booking.PaymentStatus` to Refunded.

### 7.7 Payment Return

**Description**: Handles callback from the VNPay payment gateway after payment completion.

**HTTP Method**: GET  
**Endpoint**: `/api/payments/return`  
**Authorization**: None

**Query Parameters**:

- VNPay-specific parameters (e.g., `vnp_TxnRef`, `vnp_Amount`, `vnp_ResponseCode`, `vnp_SecureHash`).

**Request Example**:

```http
GET /api/payments/return?vnp_TxnRef=1&vnp_Amount=50000000&vnp_ResponseCode=00&vnp_SecureHash=abc123
```

**Response**:

- **200 OK**: Redirects to frontend success page (`/payment/success`) or failure page (`/payment/failed`) with query parameters `paymentId` and optional `message`.

- **400 Bad Request**:

  ```json
  {
    "error": "Invalid query",
    "message": "Không tìm thấy thông tin thanh toán"
  }
  ```

**Note**:

- Redirects to `{frontendUrl}/payment/success?paymentId={paymentId}` if payment is successful.
- Redirects to `{frontendUrl}/payment/failed?paymentId={paymentId}&message={error}` if payment fails.
- `frontendUrl` is configured in `appsettings.json` (defaults to `http://localhost:5173`).

### 7.8 Payment IPN

**Description**: Handles Instant Payment Notification (IPN) from the VNPay payment gateway to update payment status.

**HTTP Method**: GET  
**Endpoint**: `/api/payments/ipn`  
**Authorization**: None

**Query Parameters**:

- VNPay-specific parameters (e.g., `vnp_TxnRef`, `vnp_Amount`, `vnp_ResponseCode`, `vnp_SecureHash`).

**Request Example**:

```http
GET /api/payments/ipn?vnp_TxnRef=1&vnp_Amount=50000000&vnp_ResponseCode=00&vnp_SecureHash=abc123
```

**Response**:

- **200 OK**:

  ```json
  {
    "message": "IPN processed successfully"
  }
  ```

- **400 Bad Request**:

  ```json
  {
    "error": "Payment failed",
    "message": "Transaction failed"
  }
  ```

**Note**:

- Updates `Payment.Status` and `Booking.PaymentStatus` via webhook processing.
- Secured by `vnp_SecureHash` verified by VNPay.
- `vnp_Amount` is divided by 100 to convert to VND.
